name: API Smoke Test (curl)

on:
  workflow_dispatch:   # k√∂rs manuellt

permissions:
  contents: read

concurrency:
  group: api-smoke-test
  cancel-in-progress: true

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Mask secrets (extra s√§kerhet)
        run: |
          echo "::add-mask::${{ secrets.OPENAI_API_KEY }}"
          echo "::add-mask::${{ secrets.ABLY_API_KEY }}"

      - name: Verify env present
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ABLY_API_KEY:   ${{ secrets.ABLY_API_KEY }}
        run: |
          set -e
          [ -z "$OPENAI_API_KEY" ] && echo "‚ùå OPENAI_API_KEY not set" && exit 1 || echo "‚úÖ OPENAI_API_KEY is set"
          [ -z "$ABLY_API_KEY"   ] && echo "‚ùå ABLY_API_KEY not set"   && exit 1 || echo "‚úÖ ABLY_API_KEY is set"

      - name: OpenAI models endpoint (sanity)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          echo "üîç H√§mtar modeller fr√•n OpenAI..."
          # H√§mta lista och verifiera att n√•gon gpt-4o* finns
          RESP=$(curl -sS --fail-with-body https://api.openai.com/v1/models \
            -H "Authorization: Bearer $OPENAI_API_KEY")
          echo "$RESP" | grep -q '"id": "gpt-4o' || echo "$RESP" | grep -q '"id": "gpt-4o-' \
            || (echo "‚ùå Kunde inte hitta gpt-4o i models-listan"; exit 1)
          echo "‚úÖ OpenAI models OK (gpt-4o hittades)"

      - name: OpenAI live call (chat.completions)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          echo "üîç K√∂r chat.completions..."
          BODY='{
            "model": "gpt-4o-mini",
            "messages": [{"role":"user","content":"S√§g: OK fr√•n Actions"}],
            "max_tokens": 8,
            "temperature": 0
          }'
          RESP=$(curl -sS --fail-with-body https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY")
          # v√§ldigt enkel extraktion utan jq
          TEXT=$(echo "$RESP" | sed -n 's/.*"content":"\([^"]*\)".*/\1/p' | head -n1)
          [ -z "$TEXT" ] && (echo "‚ùå Tomt svar fr√•n OpenAI"; echo "$RESP"; exit 1)
          echo "‚úÖ OpenAI svar: $TEXT"

      - name: Ably live call (REST time)
        env:
          ABLY_API_KEY: ${{ secrets.ABLY_API_KEY }}
        run: |
          set -e
          echo "üîç Anropar Ably /time..."
          # /time accepterar API-nyckel via query-parametern ?key=
          RESP=$(curl -sS --fail-with-body "https://rest.ably.io/time?key=$ABLY_API_KEY")
          # Svaret √§r en JSON-array med ett unix timestamp, t.ex. [1700000000000]
          echo "$RESP" | grep -qE '^\[[0-9]{10,}\]$' || (echo "‚ùå Ov√§nat svar fr√•n Ably: $RESP"; exit 1)
          echo "‚úÖ Ably time OK: $RESP"