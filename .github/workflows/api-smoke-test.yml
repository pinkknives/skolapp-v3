name: API Smoke Test (curl)

on:
  workflow_dispatch:   # körs manuellt

permissions:
  contents: read

concurrency:
  group: api-smoke-test
  cancel-in-progress: true

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Mask secrets (extra säkerhet)
        run: |
          echo "::add-mask::${{ secrets.OPENAI_API_KEY }}"
          echo "::add-mask::${{ secrets.ABLY_API_KEY }}"

      - name: Verify env present
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ABLY_API_KEY:   ${{ secrets.ABLY_API_KEY }}
        run: |
          set -e
          [ -z "$OPENAI_API_KEY" ] && echo "❌ OPENAI_API_KEY not set" && exit 1 || echo "✅ OPENAI_API_KEY is set"
          [ -z "$ABLY_API_KEY"   ] && echo "❌ ABLY_API_KEY not set"   && exit 1 || echo "✅ ABLY_API_KEY is set"

      - name: OpenAI models endpoint (sanity)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          echo "🔍 Hämtar modeller från OpenAI..."
          RESP=$(curl -sS --fail-with-body https://api.openai.com/v1/models \
            -H "Authorization: Bearer $OPENAI_API_KEY")
          HAS=$(echo "$RESP" | jq '[.data[].id | strings] | any(index("gpt-4o"))')
          if [ "$HAS" != "true" ]; then
            echo "❌ Kunde inte hitta gpt-4o i models-listan"
            exit 1
          fi
          echo "✅ OpenAI models OK (gpt-4o hittades)"

      - name: OpenAI live call (chat.completions)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          echo "🔍 Kör chat.completions..."
          BODY='{
            "model": "gpt-4o-mini",
            "messages": [{"role":"user","content":"Säg: OK från Actions"}],
            "max_tokens": 8,
            "temperature": 0
          }'
          RESP=$(curl -sS --fail-with-body https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY")
          TEXT=$(echo "$RESP" | jq -r '.choices[0].message.content')
          if [ -z "$TEXT" ] || [ "$TEXT" = "null" ]; then
            echo "❌ Tomt svar från OpenAI"
            echo "$RESP"
            exit 1
          fi
          echo "✅ OpenAI svar: $TEXT"

      - name: Ably live call (REST time)
        env:
          ABLY_API_KEY: ${{ secrets.ABLY_API_KEY }}
        run: |
          set -e
          echo "🔍 Anropar Ably /time..."
          RESP=$(curl -sS --fail-with-body "https://rest.ably.io/time?key=$ABLY_API_KEY")
          # Svaret är en JSON-array med ett unix timestamp, t.ex. [1700000000000]
          echo "$RESP" | jq -e 'type=="array" and length==1 and (.[0]|type=="number")' >/dev/null
          echo "✅ Ably time OK: $RESP"